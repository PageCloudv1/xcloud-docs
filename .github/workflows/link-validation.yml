name: 🔗 Link Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

jobs:
  link-checker:
    runs-on: ubuntu-latest
    name: Check documentation links
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🏗️ Build documentation
        run: npm run build

      - name: 🔍 Check links with Lychee
        uses: lycheeverse/lychee-action@v1.10.0
        with:
          # Check all markdown files and built HTML
          args: |
            --verbose
            --no-progress
            --max-concurrency 10
            --timeout 25
            --max-redirects 5
            --retry-wait-time 2
            --exclude-mail
            --exclude-private
            --exclude-file .lycheeignore
            --user-agent "xCloud-Docs-Bot/1.0 (Link Validation)"
            --format detailed
            './docs/**/*.md'
            './README.md'
            './build/**/*.html'
          output: lychee/out.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 📊 Generate link report
        if: always()
        run: |
          echo "## 🔗 Link Validation Report" >> $GITHUB_STEP_SUMMARY
          if [ -f lychee/out.md ]; then
            cat lychee/out.md >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ All links are working correctly!" >> $GITHUB_STEP_SUMMARY
          fi

  accessibility-check:
    runs-on: ubuntu-latest
    name: Check accessibility
    needs: link-checker
    if: github.event_name == 'pull_request'
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🏗️ Build documentation
        run: npm run build

      - name: ♿ Run accessibility audit
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: '.lighthouserc.js'
          uploadArtifacts: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
